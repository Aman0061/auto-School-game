# Обновление системы аутентификации

## Описание изменений

Система аутентификации была обновлена для использования логина вместо телефона и email:

### Что изменилось:
1. **Убрано поле `phone`** - больше не требуется ввод номера телефона
2. **Убрано поле `email`** - больше не требуется ввод email адреса
3. **Добавлено поле `username`** - уникальный логин на английском языке
4. **Обновлена логика входа** - теперь используется логин + пароль

### Новые требования к логину:
- Только английские буквы, цифры и знак подчеркивания
- Минимум 3 символа
- Максимум 20 символов
- Уникальный (не может повторяться у других пользователей)

## Файлы, которые были изменены:

### 1. Модель пользователя
- `lib/models/user.dart` - обновлена структура User

### 2. Провайдер аутентификации
- `lib/providers/auth_provider.dart` - обновлены методы register и login

### 3. Сервис пользователя
- `lib/services/user_service.dart` - обновлены методы для работы с username

### 4. Экран регистрации
- `lib/screens/registration_screen.dart` - убраны поля email и phone, добавлено поле username

### 5. Экран входа
- `lib/screens/auth_screen.dart` - обновлено поле ввода для логина

## Обновление базы данных

### Шаг 1: Выполните SQL скрипт
Используйте файл `update_users_table.sql` для обновления структуры базы данных:

```sql
-- Выполните в Supabase SQL Editor
-- Этот скрипт:
-- 1. Добавит поле username
-- 2. Создаст уникальный индекс
-- 3. Обновит существующие записи
-- 4. Проверит структуру таблицы
```

### Шаг 2: Проверьте структуру
После выполнения скрипта проверьте, что таблица содержит нужные поля:

```sql
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'users' 
ORDER BY ordinal_position;
```

## Тестирование

### 1. Регистрация нового пользователя
- Откройте экран регистрации
- Введите имя, логин и пароль
- Выберите тип пользователя
- Проверьте, что пользователь создается успешно

### 2. Вход в систему
- Откройте экран входа
- Введите логин и пароль
- Проверьте, что вход выполняется успешно

### 3. Проверка уникальности логина
- Попробуйте зарегистрировать пользователя с уже существующим логином
- Убедитесь, что система выдает ошибку о дублировании

## Важные замечания

1. **Резервное копирование**: Перед обновлением базы данных обязательно создайте резервную копию
2. **Тестирование**: Протестируйте все изменения в тестовой среде перед применением в продакшене
3. **Обратная совместимость**: Существующие пользователи получат автоматически сгенерированные логины вида `user_[id]`
4. **Миграция данных**: Если нужно сохранить email/phone пользователей, создайте отдельные таблицы или поля

## Возможные проблемы

### 1. Ошибки компиляции
Если возникают ошибки компиляции, убедитесь что:
- Все импорты обновлены
- Файл `user.g.dart` перегенерирован
- Все ссылки на старые поля исправлены

### 2. Ошибки базы данных
Если возникают ошибки в базе данных:
- Проверьте права доступа к таблице users
- Убедитесь, что поле username добавлено корректно
- Проверьте уникальность индекса

### 3. Проблемы с существующими пользователями
- Существующие пользователи получат логины вида `user_[id]`
- Они смогут войти в систему, но должны будут изменить логин на более удобный

## Откат изменений

В случае необходимости отката:
1. Восстановите резервную копию базы данных
2. Откатите изменения в коде через git
3. Перегенерируйте файлы моделей
